<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devis MELEC - RS Components</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
    .header { background: linear-gradient(90deg, #1a5fb4, #007acc); color: white; padding: 20px; text-align: center; }
    .header img { max-height: 60px; margin-bottom: 10px; border-radius: 4px; }
    .header h1 { font-size: 1.8em; margin-bottom: 5px; }
    .section { padding: 20px; border-bottom: 1px solid #eee; }
    .section:last-child { border-bottom: none; }
    .section h2 { color: #1a5fb4; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em; margin: 5px; }
    .btn:hover { background: #218838; }
    .btn-secondary { background: #6c757d; }
    .btn-danger { background: #dc3545; }
    .btn-warning { background: #ffc107; color: #212529; }
    input, textarea, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; max-width: 400px; margin: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; }
    .total { font-size: 1.2em; font-weight: bold; background: #e8f5e8; padding: 15px; border-radius: 6px; }
    .import-zone { background: #d4edda; border-left: 4px solid #28a745; }
    @media print { body { background: white; padding: 0; } .no-print { display: none !important; } }
    @media (max-width: 768px) { .container { margin: 0; border-radius: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER SOCI√âT√â -->
    <div class="header" id="headerSoc">
      <img id="logoSoc" src="" alt="Logo" style="display: none;">
      <h1 id="nomSoc">√âLEC INSTALL SARL</h1>
      <p id="adresseSoc">Chargement...</p>
    </div>

    <!-- PROJET & CLIENT -->
    <div class="section">
      <h2>üìã Projet & Client</h2>
      <input type="text" id="projet" placeholder="ex: Installation √©lectrique T2" value="Installation √©lectrique studio T2">
      <input type="text" id="client" placeholder="ex: M. Martin" value="M. Martin">
    </div>

    <!-- IMPORT RS CSV -->
    <div class="section import-zone">
      <h2>üì• Importer liste Radiospares</h2>
      <p>Cr√©e ta liste sur <a href="https://fr.rs-online.com" target="_blank">RS</a> ‚Üí Export CSV ‚Üí Glisse ici</p>
      <input type="file" id="fileCSV" accept=".csv" style="padding: 10px;">
      <button class="btn" onclick="importerCSV()">üöÄ Importer dans devis</button>
      <button class="btn btn-danger" onclick="viderPanier()">üóëÔ∏è Vider panier</button>
    </div>

    <!-- MAIN D'OEUVRE -->
    <div class="section">
      <h2>üë∑ Main d'≈ìuvre</h2>
      <label>Heures pose: <input type="number" id="heuresPose" step="0.25" value="4.0" min="0"></label>
      <label>Taux HT (‚Ç¨/h): <input type="number" id="tauxHoraire" step="0.01" value="45.00" min="0"></label>
    </div>

    <!-- SOCI√âT√â (CONFIG) -->
    <div class="section">
      <h2>üè¢ Soci√©t√©</h2>
      <input type="text" id="newNom" placeholder="Nom soci√©t√©">
      <textarea id="newAdresse" rows="3" placeholder="Adresse&#10;12 rue des Circuits&#10;94000 Cr√©teil"></textarea>
      <label>Logo: <input type="file" id="newLogo" accept="image/*"></label>
      <button class="btn" onclick="sauvegarderConfig()">üíæ Sauvegarder</button>
      <button class="btn btn-warning" onclick="reinitialiserApp()">üîÑ Tout r√©init</button>
    </div>

    <!-- PANIER -->
    <div class="section">
      <h2>üõí Panier mat√©riel</h2>
      <table id="tableauPanier">
        <thead><tr><th>R√©f RS</th><th>Description</th><th>Marque</th><th>Qt√©</th><th>PU HT ‚Ç¨</th><th>Total</th><th>Supp</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TOTAUX -->
    <div class="section total" id="totaux">
      Mat√©riel HT: 0 ‚Ç¨ | MO: 0 ‚Ç¨ | <strong>TOTAL HT: 0 ‚Ç¨</strong> | TVA 20%: 0 ‚Ç¨ | <strong>TTC: 0 ‚Ç¨</strong>
    </div>

    <!-- ACTIONS -->
    <div class="section">
      <button class="btn" onclick="exporterCSV()">üíæ Exporter CSV</button>
      <button class="btn" onclick="imprimerFacture()" class="no-print">üñ®Ô∏è Imprimer facture</button>
    </div>
  </div>

  <script>
    // √âTAT GLOBAL
    let panier = JSON.parse(localStorage.getItem('panierMELEC')) || [];
    let config = JSON.parse(localStorage.getItem('configEntreprise')) || {
      nom: '√âLEC INSTALL SARL', adresse: '12 rue des Circuits\n94000 Cr√©teil', tauxHoraire: 45.00, logo: ''
    };

    // PARSER CSV RS ROBUSTE
    function parserCSV(csvText) {
      if (!csvText) return [];
      const sep = csvText.includes(';') ? ';' : ',';
      const lignes = csvText.split('\n').map(l => l.trim()).filter(l => l);
      const items = [];
      lignes.slice(1).forEach((ligne, idx) => {
        try {
          const cols = ligne.split(new RegExp(`(?=(?:[^"]*"[^"]*")*[^"]*$)(${sep})`, 'g'))
            .map(c => c.replace(/^["\s]+|["\s]+$/g, '').trim()).filter(c => c);
          if (cols.length < 9) return;
          const refRS = cols[0] || '';
          const desc = cols[5] || cols[6] || '';
          const marque = cols[7] || '';
          let prixStr = cols[8] || '0';
          prixStr = prixStr.replace(/[‚Ç¨\sHT]+/gi, '').replace(',', '.');
          const puHT = parseFloat(prixStr) || 0;
          if (!refRS || puHT <= 0 || items.some(item => item.ref === refRS)) return;
          items.push({ ref: refRS, desc, marque, qte: 1, puHT });
        } catch (e) { console.warn(`Ligne ${idx + 2} ignor√©e`); }
      });
      return items;
    }

    // IMPORT CSV
    function importerCSV() {
      const file = document.getElementById('fileCSV').files[0];
      if (!file) return alert('Choisis un CSV RS !');
      const reader = new FileReader();
      reader.onload = e => {
        panier = [...panier, ...parserCSV(e.target.result)];
        localStorage.setItem('panierMELEC', JSON.stringify(panier));
        mettreAJourTableau();
      };
      reader.readAsText(file);
    }

    // TABLEAU PANIER
    function mettreAJourTableau() {
      const tbody = document.querySelector('#tableauPanier tbody');
      tbody.innerHTML = '';
      panier.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.ref}</td>
          <td>${item.desc}</td>
          <td>${item.marque}</td>
          <td><input type="number" value="${item.qte}" min="1" onchange="panier[${i}].qte=this.valueAsNumber; localStorage.setItem('panierMELEC',JSON.stringify(panier)); mettreAJourTableau(); mettreAJourTotaux();" style="width:60px;"></td>
          <td>${item.puHT.toFixed(2)} ‚Ç¨</td>
          <td>${(item.qte * item.puHT).toFixed(2)} ‚Ç¨</td>
          <td><button class="btn btn-danger" onclick="panier.splice(${i},1); localStorage.setItem('panierMELEC',JSON.stringify(panier)); mettreAJourTableau(); mettreAJourTotaux();">‚úï</button></td>
        `;
        tbody.appendChild(tr);
      });
      mettreAJourTotaux();
    }

    // TOTAUX
    function mettreAJourTotaux() {
      const materielHT = panier.reduce((sum, item) => sum + (item.qte * item.puHT), 0);
      const heures = parseFloat(document.getElementById('heuresPose').value) || 0;
      const taux = parseFloat(document.getElementById('tauxHoraire').value) || 0;
      const moHT = heures * taux;
      const totalHT = materielHT + moHT;
      const tva = totalHT * 0.20;
      const ttc = totalHT + tva;
      document.getElementById('totaux').innerHTML = `
        Mat√©riel HT: ${materielHT.toFixed(2)} ‚Ç¨ | MO: ${moHT.toFixed(2)} ‚Ç¨ | 
        <strong>TOTAL HT: ${totalHT.toFixed(2)} ‚Ç¨</strong> | TVA 20%: ${tva.toFixed(2)} ‚Ç¨ | 
        <strong>TTC: ${ttc.toFixed(2)} ‚Ç¨</strong>
      `;
    }

    // VIDANGE / R√âINIT
    function viderPanier() {
      if (confirm('Vider panier ?')) {
        panier = [];
        localStorage.removeItem('panierMELEC');
        mettreAJourTableau();
      }
    }
    function reinitialiserApp() {
      if (confirm('R√©initialiser tout ?')) {
        panier = []; localStorage.removeItem('panierMELEC');
        localStorage.removeItem('configEntreprise');
        location.reload();
      }
    }

    // CONFIG SOCI√âT√â
    function majHeader() {
      document.getElementById('nomSoc').textContent = config.nom;
      document.getElementById('adresseSoc').textContent = config.adresse;
      const logo = document.getElementById('logoSoc');
      if (config.logo) {
        logo.src = config.logo;
        logo.style.display = 'block';
      } else logo.style.display = 'none';
    }
    function sauvegarderConfig() {
      config.nom = document.getElementById('newNom').value || config.nom;
      config.adresse = document.getElementById('newAdresse').value || config.adresse;
      config.tauxHoraire = parseFloat(document.getElementById('tauxHoraire').value) || 45;
      const logoFile = document.getElementById('newLogo').files[0];
      if (logoFile) {
        const reader = new FileReader();
        reader.onload = e => {
          config.logo = e.target.result;
          localStorage.setItem('configEntreprise', JSON.stringify(config));
          majHeader();
        };
        reader.readAsDataURL(logoFile);
      } else {
        localStorage.setItem('configEntreprise', JSON.stringify(config));
        majHeader();
      }
      document.getElementById('newNom').value = '';
      document.getElementById('newAdresse').value = '';
    }

    // EXPORT / IMPRESSION
    function exporterCSV() {
      const csv = ['Ref,Desc,Marque,Qt√©,PU HT,Total',
        ...panier.map(item => `${item.ref},"${item.desc}",${item.marque},${item.qte},${item.puHT},${item.qte*item.puHT}`)].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'devis_melec.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function imprimerFacture() { window.print(); }

    // √âV√âNEMENTS
    document.getElementById('fileCSV').addEventListener('change', importerCSV);
    document.getElementById('heuresPose').addEventListener('input', mettreAJourTotaux);
    document.getElementById('tauxHoraire').addEventListener('input', mettreAJourTotaux);

    // INIT
    document.getElementById('newNom').value = config.nom;
    document.getElementById('newAdresse').value = config.adresse;
    document.getElementById('tauxHoraire').value = config.tauxHoraire;
    majHeader();
    mettreAJourTableau();
  </script>
</body>
</html>
